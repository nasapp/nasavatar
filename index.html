<!doctype html>
<html class="no-js">
  <head>
    <meta charset="utf-8">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
    <meta http-equiv="Access-Control-Allow-Origin" content="*">
    <title>avatar on nas</title>
    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="styles/vendor.css">

    <link rel="stylesheet" href="styles/main.css">
    
    <script src="scripts/vendor/modernizr.js"></script>
  </head>
  <body>
    <!--[if IE]>
      <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
    
    <div class="container">
      <div class="header">
        <ul class="nav nav-pills float-right">
          <li class="nav-item">
            <a class="nav-link" href="https://github.com/ChengOrangeJu/WebExtensionWallet" target="_blank">安装星云钱包插件</a>
          </li>
        </ul>
        <h3 class="text-muted">avatar on nas</h3> 
        <h6 class="text-muted">合约地址:n1fyqCkaLEYSA5njL3bBauzBKH6cNgiZBjR 调用函数:get 参数:钱包地址</h6>    
      </div>

      <div class="container">
        <div class="row">
            <div class="col-md-9">
                <h6>为每个星云链上的钱包地址生成一个头像(avatar),可以在任何基于星云链的应用中使用个性化的头像代替钱包地址。需使用Chrome浏览器并且安装星云钱包插件。</h6>
            </div>
          <div class="col-md-9">
            
            <div class="img-container">
              <img id="image" src="" alt="">
            </div>
          </div>
          <div class="col-md-3">
            
            <div class="docs-preview clearfix">
              <div class="img-preview preview-square"></div>
              <div class="img-preview preview-round"></div>
            </div>
           
            <div class="btn-group btn-group-crop" style="text-align:center">
              <label class="btn btn-primary btn-success" for="inputImage" title="Upload image file" style="width:180px">
                <input type="file" class="sr-only" id="inputImage" name="file" accept=".jpg,.jpeg,.png,.gif,.bmp,.tiff">
                <span class="docs-tooltip" data-toggle="tooltip" data-animation="false">
                  上传图片
                </span>
              </label>
            </div>
            <br> <br>
            <div class="btn-group btn-group-crop docs-buttons" style="text-align:center">
              <button type="button" class="btn btn-success" data-method="getCroppedCanvas" data-option="{ &quot;width&quot;: 100, &quot;height&quot;: 100 }" style="width:180px">
                <span class="docs-tooltip" data-toggle="tooltip" data-animation="false">
                  保存到NAS
                </span>
              </button>
            </div>
            <div>
              当前头像:
              <img id="navimage" src="" alt="" width="100px" height="100px">
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-9 docs-buttons" style="text-align:center">
            
            <div class="btn-group">
              <button type="button" class="btn btn-primary" data-method="zoom" data-option="0.1" title="Zoom In">
                <span class="docs-tooltip" data-toggle="tooltip" data-animation="false">
                  <span class="fa fa-search-plus"></span>
                </span>
              </button>
              <button type="button" class="btn btn-primary" data-method="zoom" data-option="-0.1" title="Zoom Out">
                <span class="docs-tooltip" data-toggle="tooltip" data-animation="false">
                  <span class="fa fa-search-minus"></span>
                </span>
              </button>
            </div>
    
            <div class="btn-group">
              <button type="button" class="btn btn-primary" data-method="move" data-option="-10" data-second-option="0" title="Move Left">
                <span class="docs-tooltip" data-toggle="tooltip" data-animation="false">
                  <span class="fa fa-arrow-left"></span>
                </span>
              </button>
              <button type="button" class="btn btn-primary" data-method="move" data-option="10" data-second-option="0" title="Move Right">
                <span class="docs-tooltip" data-toggle="tooltip" data-animation="false">
                  <span class="fa fa-arrow-right"></span>
                </span>
              </button>
              <button type="button" class="btn btn-primary" data-method="move" data-option="0" data-second-option="-10" title="Move Up">
                <span class="docs-tooltip" data-toggle="tooltip" data-animation="false">
                  <span class="fa fa-arrow-up"></span>
                </span>
              </button>
              <button type="button" class="btn btn-primary" data-method="move" data-option="0" data-second-option="10" title="Move Down">
                <span class="docs-tooltip" data-toggle="tooltip" data-animation="false">
                  <span class="fa fa-arrow-down"></span>
                </span>
              </button>
            </div>
    
            <div class="btn-group">
              <button type="button" class="btn btn-primary" data-method="rotate" data-option="-45" title="Rotate Left">
                <span class="docs-tooltip" data-toggle="tooltip" data-animation="false">
                  <span class="fa fa-rotate-left"></span>
                </span>
              </button>
              <button type="button" class="btn btn-primary" data-method="rotate" data-option="45" title="Rotate Right">
                <span class="docs-tooltip" data-toggle="tooltip" data-animation="false">
                  <span class="fa fa-rotate-right"></span>
                </span>
              </button>
            </div>
    
            <div class="btn-group">
              <button type="button" class="btn btn-primary" data-method="scaleX" data-option="-1" title="Flip Horizontal">
                <span class="docs-tooltip" data-toggle="tooltip" data-animation="false">
                  <span class="fa fa-arrows-h"></span>
                </span>
              </button>
              <button type="button" class="btn btn-primary" data-method="scaleY" data-option="-1" title="Flip Vertical">
                <span class="docs-tooltip" data-toggle="tooltip" data-animation="false">
                  <span class="fa fa-arrows-v"></span>
                </span>
              </button>
            </div>
            
          </div>
        </div>
      </div> 

      <div class="footer">
        <p>Power by nasapp.</p>
      </div>
    </div>

    <script src="scripts/nebulas.js"></script>
    <script src="scripts/nebPay.js"></script>
    <script src="scripts/vendor.js"></script>
    
    <script src="scripts/plugins.js"></script>
    
    <script src="scripts/main.js"></script>
    <script>
        var nebulas = require("nebulas");
        var NebPay = require("nebpay");
        var neb = new nebulas.Neb();
        var nebPay = new NebPay();
        neb.setRequest(new nebulas.HttpRequest("https://mainnet.nebulas.io"));
        var dappAddress = "n1fyqCkaLEYSA5njL3bBauzBKH6cNgiZBjR";
        var currentUserAddress = "";
        setTimeout(function () {
            if (!window.webExtensionWallet) {
                alert("请先安装星云钱包插件.");
             } else {
                 window.postMessage({
                    "target": "contentscript",
                    "data": {},
                    "method": "getAccount",
                }, "*");
                window.addEventListener('message', function (e) {
                    if (e.data && e.data.data) {
                        if (e.data.data.account) {//这就是当前钱包中的地址
                            currentUserAddress = e.data.data.account;
                            getavatar(currentUserAddress,"#navimage");
                        }
                    }
                });
            }
        }, 1000); //等待加载钱包

        function getavatar(address,imageid) {
            address = address.trim();
            if (!address) {
                console.log("请输入您的星云链地址");
                return;
            }
            var value = "0";
            var gas_price = "1000000"
            var gas_limit = "2000000"
            var callFunction = "get";
            var callArgs = JSON.stringify([address]);
            var contract = {
                "function": callFunction,
                "args": callArgs
            }
            neb.api.call(currentUserAddress, dappAddress, value, '0', gas_price, gas_limit, contract).then(function (resp) {
                if (resp.execute_err.length > 0) {
                    throw new Error(resp.execute_err);
                }
                var result = JSON.parse(resp.result);
                if (!result) {
                    throw new Error(resp);
                }
                $(imageid).attr('src',result); 
            }).catch(function (err) {
              throw new Error(err.message);
            });
        }

        var serialNumber;
        function onCallClick(callFunction,arg) {
          //hash:998cc96096173d016f7ed77c88270cce2a594f8d88f9bb102a640a0406f219b4
            var to = dappAddress;
            var value = 0;
            var callFunction = callFunction;
            var callArgs = "[\"" + arg + "\"]";
            serialNumber = nebPay.call(to, value, callFunction, callArgs, {
                qrcode: {
                    showQRCode: false
                },
                goods: {
                    name: "avatar",
                    desc: "avatar"
                },
                listener: listener  //set listener for extension transaction result
            });
            $("#navimage").attr('src',arg); 
        }
        function listener(resp) {
            console.log("resp: " + JSON.stringify(resp));
            //console.log(resp);
        }
    </script>  
  </body>
</html>
